@if (errorMessage()) {
  <div class="toast">{{ errorMessage() }}</div>
}

@if (!currentUser()) {
  <section class="auth-shell">
    <div class="auth-card">
      <header>
        <h1>Welcome back</h1>
        <p>Sign in to keep your tasks organized.</p>
      </header>
      <div class="auth-tabs">
        <button class="tab-btn" [class.active]="authMode() === 'login'" (click)="setAuthMode('login')">
          Login
        </button>
        <button class="tab-btn" [class.active]="authMode() === 'register'" (click)="setAuthMode('register')">
          Register
        </button>
      </div>
      <div class="auth-form">
        <label>
          Email
          <input type="email" [ngModel]="authEmail()" (ngModelChange)="authEmail.set($event)" />
        </label>
        <label>
          Password
          <input type="password" [ngModel]="authPassword()" (ngModelChange)="authPassword.set($event)" />
        </label>
        @if (authMode() === 'register') {
          <div class="auth-row">
            <label>
              First name
              <input type="text" [ngModel]="authFirstName()" (ngModelChange)="authFirstName.set($event)" />
            </label>
            <label>
              Last name
              <input type="text" [ngModel]="authLastName()" (ngModelChange)="authLastName.set($event)" />
            </label>
          </div>
        }
        @if (authError()) {
          <div class="auth-error">{{ authError() }}</div>
        }
        <button class="btn-primary" (click)="authMode() === 'login' ? submitLogin() : submitRegister()">
          {{ authMode() === 'login' ? 'Sign in' : 'Create account' }}
        </button>
      </div>
    </div>
  </section>
} @else {
  <header class="header">
    <div class="header-text">
      <h1>Todos</h1>
      <p>Stay organized, one task at a time</p>
    </div>
    <div class="header-actions">
      <div class="user-badge">
        {{ currentUser()?.email }}
      </div>
      <button class="btn-secondary" (click)="logout()">Logout</button>
      <button class="theme-toggle" (click)="toggleDarkMode()" aria-label="Toggle dark mode">
        {{ darkMode() ? '&#9788;' : '&#9789;' }}
      </button>
    </div>
  </header>

  <nav class="tabs" aria-label="Primary navigation">
    <button class="tab-btn" [class.active]="activeTab() === 'todos'" (click)="setTab('todos')">
      Todos
    </button>
    <button class="tab-btn" [class.active]="activeTab() === 'calendar'" (click)="setTab('calendar')">
      Calendar
    </button>
  </nav>

  @if (activeTab() === 'todos') {
  <div class="add-form">
    <input
      type="text"
      [ngModel]="newTitle()"
      (ngModelChange)="newTitle.set($event)"
      placeholder="What needs to be done?"
      (keyup.enter)="add()"
      aria-label="New todo title"
    />
    <textarea
      rows="3"
      [ngModel]="newDescription()"
      (ngModelChange)="newDescription.set($event)"
      placeholder="Add a short description (optional)"
      aria-label="New todo description"
    ></textarea>
    <div class="datetime-range">
      <label class="datetime-field" (click)="openPicker(newStartInput)">
        <span>Start</span>
        <input
          type="datetime-local"
          #newStartInput
          [ngModel]="newStartAt()"
          (ngModelChange)="onNewStartAtChange($event)"
        />
      </label>
      <label class="datetime-field" (click)="openPicker(newEndInput)">
        <span>End</span>
        <input
          type="datetime-local"
          #newEndInput
          [ngModel]="newEndAt()"
          (ngModelChange)="newEndAt.set($event)"
          (focus)="onNewEndFocus()"
        />
      </label>
    </div>
    <p class="datetime-hint">Leave both empty to keep this todo unscheduled.</p>
    <div class="priority-selector" role="group" aria-label="Select priority">
      @for (p of PRIORITIES; track p) {
        <label class="priority-option">
          <input
            type="radio"
            name="priority"
            [value]="p"
            [(ngModel)]="newPriority"
            [attr.aria-label]="'Priority: ' + getPriorityLabel(p)"
          />
          <span class="priority-label">{{ getPriorityLabel(p) }}</span>
        </label>
      }
    </div>
    <button class="btn-primary" (click)="add()" [disabled]="!newTitle().trim()">Add</button>
  </div>

  <div class="todo-summary">
    @if (scheduledWeekCount() > 0) {
      <button class="scheduled-card" (click)="goToCalendarWeek()">
        Scheduled this week ({{ scheduledWeekCount() }})
      </button>
    }
  </div>

  <nav class="filters" aria-label="Filter todos">
    @for (f of ['all', 'active', 'completed']; track f) {
      <button
        class="filter-btn"
        [class.active]="filter() === f"
        (click)="setFilter($any(f))"
      >{{ f | titlecase }}</button>
    }
  </nav>

  <ul class="todo-list">
    @for (todo of filteredTodos(); track todo.id) {
      <li class="todo-item" [class.completed]="todo.isCompleted" [class.editing]="editingId() === todo.id">
        @if (editingId() === todo.id) {
          <div class="todo-edit">
            <div class="todo-edit-row">
              <input
                type="text"
                [ngModel]="editTitle()"
                (ngModelChange)="editTitle.set($event)"
                aria-label="Edit todo title"
              />
              <label class="edit-toggle">
                <input
                  type="checkbox"
                  [checked]="editIsCompleted()"
                  (change)="editIsCompleted.set($any($event.target).checked)"
                />
                <span>Completed</span>
              </label>
            </div>
            <textarea
              rows="2"
              [ngModel]="editDescription()"
              (ngModelChange)="editDescription.set($event)"
              aria-label="Edit todo description"
            ></textarea>
            <div class="todo-edit-row">
              <label>
                Priority
                <select [ngModel]="editPriority()" (ngModelChange)="editPriority.set($event)">
                  @for (p of PRIORITIES; track p) {
                    <option [value]="p">{{ getPriorityLabel(p) }}</option>
                  }
                </select>
              </label>
              <label (click)="openPicker(editStartInput)">
                Start
                <input
                  type="datetime-local"
                  #editStartInput
                  [ngModel]="editStartAt()"
                  (ngModelChange)="onEditStartAtChange($event)"
                />
              </label>
              <label (click)="openPicker(editEndInput)">
                End
                <input
                  type="datetime-local"
                  #editEndInput
                  [ngModel]="editEndAt()"
                  (ngModelChange)="editEndAt.set($event)"
                  (focus)="onEditEndFocus()"
                />
              </label>
            </div>
            <div class="todo-edit-actions">
              <button class="btn-secondary" (click)="cancelEdit()">Cancel</button>
              <button class="btn-primary" (click)="saveEdit()">Save</button>
            </div>
          </div>
        } @else {
          <label class="todo-checkbox">
            <input
              type="checkbox"
              [checked]="todo.isCompleted"
              (change)="toggle(todo.id)"
            />
            <span class="checkmark"></span>
          </label>
          <div class="todo-content">
            <span class="todo-title">{{ todo.title }}</span>
            @if (todo.description) {
              <span class="todo-description">{{ todo.description }}</span>
            }
          </div>
          <span class="priority-badge" [attr.data-priority]="todo.priority.toLowerCase()">
            {{ getPriorityLabel(todo.priority) }}
          </span>
          <button class="btn-edit" (click)="startEdit(todo)" aria-label="Edit todo">Edit</button>
          <button class="btn-delete" (click)="deleteTodo(todo.id)" aria-label="Delete todo">
            &times;
          </button>
        }
      </li>
    } @empty {
      <li class="empty-state">
        @if (filter() === 'all') {
          <span class="empty-icon">&#9744;</span>
          <span>No todos yet. Add one above!</span>
        } @else if (filter() === 'active') {
          <span class="empty-icon">&#10003;</span>
          <span>All caught up! No active todos.</span>
        } @else {
          <span class="empty-icon">&#9744;</span>
          <span>No completed todos yet.</span>
        }
      </li>
    }
  </ul>
  } @else {
  <section class="calendar">
    <div class="calendar-top">
      <div class="calendar-title">
        <div class="calendar-controls">
          <button class="nav-btn" (click)="calendarView() === 'month' ? changeMonth(-1) : calendarView() === 'week' ? changeWeek(-1) : changeDay(-1)">
            &#8249;
          </button>
          <button class="nav-btn" (click)="goToToday()">Today</button>
          <button class="nav-btn" (click)="calendarView() === 'month' ? changeMonth(1) : calendarView() === 'week' ? changeWeek(1) : changeDay(1)">
            &#8250;
          </button>
          <span>{{ getCalendarTitle() }}</span>
        </div>
        <div class="calendar-view-switch">
          <button class="pill" [class.active]="calendarView() === 'day'" (click)="setCalendarView('day')">Day</button>
          <button class="pill" [class.active]="calendarView() === 'week'" (click)="setCalendarView('week')">Week</button>
          <button class="pill" [class.active]="calendarView() === 'month'" (click)="setCalendarView('month')">Month</button>
        </div>
      </div>
      <div class="calendar-meta">
        <div class="calendar-selects">
          <select [ngModel]="getMonthIndex()" (ngModelChange)="setMonth($event)">
            @for (month of MONTHS; track month; let i = $index) {
              <option [value]="i">{{ month }}</option>
            }
          </select>
          <select [ngModel]="getYear()" (ngModelChange)="setYear($event)">
            @for (year of getYearOptions(); track year) {
              <option [value]="year">{{ year }}</option>
            }
          </select>
        </div>
        @if (unscheduledCount() > 0) {
          <button class="unscheduled-card" (click)="setTab('todos')">
            Unscheduled todos ({{ unscheduledCount() }})
          </button>
        }
      </div>
    </div>

    @if (calendarView() === 'month') {
      <div class="calendar-grid">
        @for (weekday of WEEKDAYS; track weekday) {
          <div class="calendar-weekday">{{ weekday }}</div>
        }
        @for (cell of monthCells(); track cell.date.toISOString()) {
          <div
            class="calendar-cell"
            [class.is-other]="!cell.isCurrentMonth"
            [class.is-today]="cell.isToday"
            [class.is-selected]="cell.isSelected"
            (click)="selectDay(cell.date)"
          >
            <span class="calendar-date">{{ cell.date.getDate() }}</span>
            <div class="calendar-items">
              @for (todo of cell.items.slice(0, 3); track todo.id) {
                <div class="calendar-item" (click)="openCalendarEdit(todo, $event)">
                  <label class="calendar-check" (click)="$event.stopPropagation()">
                    <input
                      type="checkbox"
                      [checked]="todo.isCompleted"
                      (change)="toggleFromCalendar(todo, $event)"
                    />
                    <span class="calendar-switch"></span>
                    <span class="calendar-label">Done</span>
                  </label>
                  <span>{{ todo.title }}</span>
                  <span class="calendar-item-time">{{ getTodoTimeRange(todo) }}</span>
                </div>
              }
              @if (cell.items.length > 3) {
                <div class="calendar-more">+{{ cell.items.length - 3 }} more</div>
              }
            </div>
          </div>
        }
      </div>
    } @else if (calendarView() === 'week') {
      <div class="week-grid">
        @for (day of weekDays(); track day.toISOString()) {
          <div class="week-column">
            <div class="week-header">
              <span>{{ day | date:'EEE' }}</span>
              <strong>{{ day.getDate() }}</strong>
            </div>
            <div class="week-items">
              @for (todo of getWeekDayTodos(day); track todo.id) {
                <div class="week-item" (click)="openCalendarEdit(todo, $event)">
                  <label class="calendar-check" (click)="$event.stopPropagation()">
                    <input
                      type="checkbox"
                      [checked]="todo.isCompleted"
                      (change)="toggleFromCalendar(todo, $event)"
                    />
                    <span class="calendar-switch"></span>
                    <span class="calendar-label">Done</span>
                  </label>
                  <span class="week-item-time">{{ getTodoTimeRange(todo) }}</span>
                  <span class="week-item-title">{{ todo.title }}</span>
                </div>
              } @empty {
                <span class="week-empty">No items</span>
              }
            </div>
          </div>
        }
      </div>
    } @else {
      <div class="day-view">
        <div class="day-header">{{ calendarDate() | date:'fullDate' }}</div>
        <div class="day-list">
          @for (todo of dayTodos(); track todo.id) {
            <div class="day-item" (click)="openCalendarEdit(todo, $event)">
              <label class="calendar-check" (click)="$event.stopPropagation()">
                <input
                  type="checkbox"
                  [checked]="todo.isCompleted"
                  (change)="toggleFromCalendar(todo, $event)"
                />
                <span class="calendar-switch"></span>
                <span class="calendar-label">Done</span>
              </label>
              <div class="day-item-time">{{ getTodoTimeRange(todo) }}</div>
              <div class="day-item-body">
                <strong>{{ todo.title }}</strong>
                @if (todo.description) {
                  <span>{{ todo.description }}</span>
                }
              </div>
            </div>
          } @empty {
            <div class="day-empty">No scheduled todos for this day.</div>
          }
        </div>
      </div>
    }
  </section>
}
}

@if (calendarEditOpen()) {
  <div class="modal-backdrop" (click)="closeCalendarEdit()">
    <div class="modal" (click)="$event.stopPropagation()">
      <header class="modal-header">
        <h3>Edit scheduled todo</h3>
        <button class="icon-btn" (click)="closeCalendarEdit()">&times;</button>
      </header>
      <div class="modal-body">
        <label>
          Title
          <input type="text" [ngModel]="calendarEditTitle()" (ngModelChange)="calendarEditTitle.set($event)" />
        </label>
        <label>
          Description
          <textarea rows="3" [ngModel]="calendarEditDescription()" (ngModelChange)="calendarEditDescription.set($event)"></textarea>
        </label>
        <div class="modal-row">
          <label>
            Priority
            <select [ngModel]="calendarEditPriority()" (ngModelChange)="calendarEditPriority.set($event)">
              @for (p of PRIORITIES; track p) {
                <option [value]="p">{{ getPriorityLabel(p) }}</option>
              }
            </select>
          </label>
          <label class="edit-toggle">
            <input
              type="checkbox"
              [checked]="calendarEditIsCompleted()"
              (change)="calendarEditIsCompleted.set($any($event.target).checked)"
            />
            <span>Completed</span>
          </label>
        </div>
        <div class="modal-row">
          <label (click)="openPicker(calendarStartInput)">
            Start
            <input
              type="datetime-local"
              #calendarStartInput
              [ngModel]="calendarEditStartAt()"
              (ngModelChange)="onCalendarStartAtChange($event)"
            />
          </label>
          <label (click)="openPicker(calendarEndInput)">
            End
            <input
              type="datetime-local"
              #calendarEndInput
              [ngModel]="calendarEditEndAt()"
              (ngModelChange)="calendarEditEndAt.set($event)"
              (focus)="onCalendarEndFocus()"
            />
          </label>
        </div>
        <button class="btn-link" (click)="calendarEditStartAt.set(''); calendarEditEndAt.set('')">
          Clear schedule
        </button>
      </div>
      <footer class="modal-actions">
        <button class="btn-secondary" (click)="closeCalendarEdit()">Cancel</button>
        <button class="btn-primary" (click)="saveCalendarEdit()">Done</button>
      </footer>
    </div>
  </div>
}
